<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5×5 Grid Shuffler</title>
  <style>
    :root{
      --ink:#e6e8ef;--muted:#9aa3b2;
      --blue:#5ad3ff;--red:#ff4d6d;
      --radius:18px;--gap:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{font-weight:800;font-size:clamp(20px, 2.6vw, 34px);letter-spacing:0.2px;margin:0}
    header .sub{color:var(--muted);font-size:0.95rem}
    .layout{display:grid;grid-template-columns:380px 1fr;gap:20px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .card{background:transparent;border:1px solid transparent;border-radius:var(--radius);padding:16px;box-shadow:none}

    textarea{width:100%;height:280px;background:#0e1320;color:var(--ink);border:1px solid #273149;outline:none;border-radius:12px;padding:12px;resize:vertical}
    textarea::placeholder{color:#6b7280}

    .controls{display:grid;gap:10px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:0.95rem}
    input[type="text"],input[type="number"]{background:#0e1320;border:1px solid #273149;color:var(--ink);border-radius:10px;padding:8px 10px;min-width:0}

    .btn{appearance:none;border:none;border-radius:14px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--blue),var(--red));color:#0b0e14}
    .btn.ghost{background:transparent;border:1px solid #2a3552;color:var(--ink)}
    .btn:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:var(--gap);width:100%}

    .cell{min-height:120px;display:flex;align-items:center;justify-content:center;text-align:center;padding:12px;border-radius:16px;position:relative;overflow:hidden;cursor:pointer}
    .cell{border:3px solid transparent;border-image:linear-gradient(135deg,var(--blue),var(--red)) 1}
    .cell::after{content:"";position:absolute;inset:6px;border-radius:14px;border:1px solid rgba(255,255,255,.08);pointer-events:none}
    .cell .glow{position:absolute;inset:-2px;border-radius:inherit;background:
      radial-gradient(120% 150% at 20% -10%, rgba(90,211,255,.18), transparent 60%),
      radial-gradient(120% 150% at 120% 120%, rgba(255,77,109,.16), transparent 60%);
      opacity:.0;filter:saturate(140%);transition:opacity .2s ease}
    .cell:hover .glow,.cell.crossed .glow{opacity:.9}

    .cell .txt{position:relative;font-weight:800;letter-spacing:.2px;
      text-shadow:0 0 1px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.35);
      font-size:clamp(12px, 1.4vw, 22px); line-height:1.2; word-break:break-word}
    .cell .idx{position:absolute;top:6px;left:8px;color:#8a93a6;font-size:12px}

    .cell.crossed .txt{ text-decoration: line-through; text-decoration-thickness: 3px; text-decoration-color: rgba(255,255,255,.9); opacity:.9 }
    .cell.crossed::before{ content:""; position:absolute; left:8%; right:8%; top:50%; height:3px; background:linear-gradient(90deg,var(--blue),var(--red)); box-shadow:0 0 10px rgba(255,77,109,.45),0 0 12px rgba(90,211,255,.35); transform:translateY(-1px)}

    .cell.bingo-row,.cell.bingo-col{outline:2px solid transparent; box-shadow:0 0 18px rgba(90,211,255,.45), 0 0 26px rgba(255,77,109,.35)}
    .cell.bingo-row .glow,.cell.bingo-col .glow{opacity:1}
    .cell.bingo-row{animation:blinkBlue 1.2s ease-in-out infinite alternate}
    .cell.bingo-col{animation:blinkRed 1.2s ease-in-out infinite alternate}
    @keyframes blinkBlue{from{filter:none} to{filter:drop-shadow(0 0 10px var(--blue))}}
    @keyframes blinkRed{from{filter:none} to{filter:drop-shadow(0 0 10px var(--red))}}

    .footer{margin-top:10px;color:var(--muted);font-size:0.92rem}
    .error{color:#ff8b8b}
    .ok{color:#7bf1a8}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3552;border-radius:999px;padding:6px 10px;color:var(--muted);font-size:0.9rem}
    .sp{flex:1}

    .obs-mode .layout{grid-template-columns:1fr}
    .obs-mode section.card:first-of-type, .obs-mode header .badge, .obs-mode header .sub {display:none}
    .obs-mode header h1{font-size:20px;opacity:.6}
    .obs-mode .cell .txt{font-size:clamp(16px, 2.2vw, 36px)}
    .obs-mode .cell .idx{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>5×5 Grid Shuffler</h1>
        <div class="sub">Editor + live OBS view (add <code>?obs=1</code> to URL for display mode)</div>
      </div>
      <div class="badge" title="State syncs via BroadcastChannel + localStorage">Live Sync</div>
    </header>

    <div class="layout">
      <section class="card">
        <label for="items"><strong>List</strong> (one per line)</label>
        <textarea id="items" placeholder="Enter at least 25 lines…"></textarea>

        <div class="controls">
          <div class="row">
            <button id="btnFill" class="btn primary">Shuffle & Fill</button>
            <button id="btnAgain" class="btn ghost">Shuffle Again</button>
            <button id="btnClearCrosses" class="btn ghost">Clear Crosses</button>
            <span class="sp"></span>
            <button id="btnClear" class="btn ghost">Clear</button>
          </div>
          <div class="row">
            <label><input type="checkbox" id="allowRepeats"> Allow repeats if fewer than 25 items</label>
            <label>Seed <input id="seed" type="text" placeholder="optional" /></label>
          </div>
          <div class="footer" id="status"></div>
        </div>
      </section>

      <section class="card">
        <div class="grid" id="grid" aria-live="polite"></div>
      </section>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const OBS_MODE = new URLSearchParams(location.search).has("obs");
if (OBS_MODE) document.body.classList.add("obs-mode");

const CHANNEL = "gridshuffler:channel";
let bc;
try { bc = new BroadcastChannel(CHANNEL); } catch(_) { bc = null; }
const STORAGE_KEY = "gridshuffler:state";

function seedRNG(seedStr){
  if(!seedStr) return Math.random;
  let h = 1779033703 ^ seedStr.split('').reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0)|0,0);
  h = Math.imul(h ^ (h>>>16), 2246822507);
  h = Math.imul(h ^ (h>>>13), 3266489909);
  return function(){
    h = (h + 0x6D2B79F5)|0;
    let t = Math.imul(h ^ (h>>>15), 1 | h);
    t ^= t + Math.imul(t ^ (t>>>7), 61 | t);
    return ((t ^ (t>>>14)) >>> 0) / 4294967296;
  }
}
function shuffle(arr, rnd=Math.random){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(rnd()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function sample25(lines, allowRepeats, rnd){
  const cleaned = lines.map(s=>s.trim()).filter(s=>s.length>0);
  if(cleaned.length === 0) return Array(25).fill("");
  if(cleaned.length >= 25) return shuffle(cleaned, rnd).slice(0,25);
  if(!allowRepeats) throw new Error(`You provided ${cleaned.length} item(s). Add ${25-cleaned.length} more or enable repeats.`);
  const out = []; let pool = shuffle(cleaned, rnd);
  while(out.length < 25){ if(pool.length===0) pool = shuffle(cleaned, rnd); out.push(pool.pop()); }
  return out;
}

const grid = $('#grid'), ta = $('#items'), allowRepeats = $('#allowRepeats'), seedInput = $('#seed'), status = $('#status');

function getCell(r,c){ return document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`); }
function getTexts(){ return $$('.cell .txt').map(n=>n.textContent); }
function getCrossed(){ return $$('.cell').map(n=>n.classList.contains('crossed')); }
function crossedMatrix(){ const arr = getCrossed(); return Array.from({length:5},(_,r)=>arr.slice(r*5,(r+1)*5)); }

function renderGrid(items){
  grid.innerHTML = '';
  items.forEach((txt, i)=>{
    const r = Math.floor(i/5), c = i % 5;
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.row = r; cell.dataset.col = c;
    cell.innerHTML = `<span class="idx">${i+1}</span><div class="txt" title="${txt.replace(/\\"/g,'\\\\\\"')}">${txt || '&nbsp;'}</div><div class="glow"></div>`;
    grid.appendChild(cell);
    cell.addEventListener('click', ()=>{ cell.classList.toggle('crossed'); updateBingos(); publishState('cross'); });
  });
  updateBingos();
  if (status) status.innerHTML = `<span class="ok">Filled ${items.filter(Boolean).length}/25 cells.</span>`;
}

function updateBingos(){
  $$('.cell').forEach(c=>c.classList.remove('bingo-row','bingo-col'));
  const crossed = crossedMatrix();
  for(let r=0;r<5;r++){ if([0,1,2,3,4].every(c=>crossed[r][c])) for(let c=0;c<5;c++) getCell(r,c)?.classList.add('bingo-row'); }
  for(let c=0;c<5;c++){ if([0,1,2,3,4].every(r=>crossed[r][c])) for(let r=0;r<5;r++) getCell(r,c)?.classList.add('bingo-col'); }
}

function fillFromTextarea(){
  try{
    const lines = (ta?.value || '').split(/\\r?\\n/);
    const rnd = seedRNG((seedInput?.value || '').trim());
    const items = sample25(lines, !!(allowRepeats&&allowRepeats.checked), rnd);
    renderGrid(items);
    publishState('fill');
  }catch(err){
    if (status) status.innerHTML = `<span class="error">${err.message}</span>`;
  }
}

$('#btnFill')?.addEventListener('click', fillFromTextarea);
$('#btnAgain')?.addEventListener('click', ()=>{
  if(!ta?.value.trim()) { if(status) status.innerHTML = '<span class="error">Add some items first.</span>'; return; }
  fillFromTextarea();
});
$('#btnClear')?.addEventListener('click', ()=>{
  if (ta) ta.value = '';
  renderGrid(Array(25).fill(''));
  publishState('clear');
  if (status) status.textContent = '';
});
$('#btnClearCrosses')?.addEventListener('click', ()=>{
  $$('.cell.crossed').forEach(c=>c.classList.remove('crossed'));
  updateBingos(); publishState('uncross-all');
});

function currentState(){
  return {
    v:2,
    items: ta ? ta.value : getTexts().join('\\n'),
    allow: allowRepeats ? !!allowRepeats.checked : true,
    seed: seedInput ? seedInput.value : '',
    texts: getTexts(),
    crossed: getCrossed(),
    ts: Date.now()
  };
}
function publishState(reason){
  const state = currentState();
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(_){}
  if (bc) try{ bc.postMessage({type:'state', reason, state}); }catch(_){}
}
function applyState(state){
  const texts = state?.texts || [];
  const items = texts.length ? texts : Array(25).fill('');
  renderGrid(items);
  if (state?.crossed && state.crossed.length === 25){
    $$('.cell').forEach((c, i)=>{ if(state.crossed[i]) c.classList.add('crossed'); });
    updateBingos();
  }
  if (ta && typeof state?.items === 'string') ta.value = state.items;
  if (allowRepeats && typeof state?.allow === 'boolean') allowRepeats.checked = state.allow;
  if (seedInput && typeof state?.seed === 'string') seedInput.value = state.seed;
}
function loadFromStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_){ return null; }
}

if (bc) bc.onmessage = (ev)=>{
  if (ev?.data?.type === 'state' && ev.data.state){
    applyState(ev.data.state);
  }
};
window.addEventListener('storage', (e)=>{
  if (e.key === STORAGE_KEY && e.newValue){
    try{ applyState(JSON.parse(e.newValue)); }catch(_){}
  }
});

(function init(){
  if (OBS_MODE){
    document.title = '5×5 Grid – OBS View';
    const s = loadFromStorage();
    if (s) applyState(s); else renderGrid(Array(25).fill(''));
  }else{
    const s = loadFromStorage();
    if (s) applyState(s);
    else {
      renderGrid(Array(25).fill(''));
      if (ta && !ta.value.trim()){
        ta.value = [
          'Alpha','Bravo','Charlie','Delta','Echo',
          'Foxtrot','Golf','Hotel','India','Juliett',
          'Kilo','Lima','Mike','November','Oscar',
          'Papa','Quebec','Romeo','Sierra','Tango',
          'Uniform','Victor','Whiskey','X-ray','Yankee','Zulu'
        ].join('\\n');
      }
    }
  }
})();
</script>
</body>
</html>
